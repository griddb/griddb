# GridDB CE 5.9

## 変更点

GridDB CE V5.9の主な変更点は以下のとおりです。

- SQL最適化の強化

    コストベースによる索引スキャン最適化：これまでに、「複数のジョイン処理のジョイン順序」、「ジョイン処理におけるジョイン方向（駆動表・内部表）」の決め方について、コストベースに対応してきました。今回、SQL処理において、統計情報をもとにコストベースで最適な索引スキャンを決定し、それに従ったプラン生成および実行が可能になりました。

- スケジューリング機能の強化

    SQLリソーススケジューリング機能：定められたリソース範囲内でSQL処理を適切にスケジューリングし、応答時間とリソース利用効率の改善を行います。「処理順序制御」、「メモリ使用量に応じた実行制御」、「リソース監視」の3つの機能から構成されます。

- 時系列データ管理・検索機能の強化

    行パターン認識機能：標準SQLのSQL:2016で規格化された行パターン認識をサポートしました。値の変化パターン（例：上昇・下降・一定など）に基づく検索が可能になりました。

---

## コストベースによる索引スキャン最適化

結合処理における索引スキャンの方法の決め方には、コストベースによる方法とルールベースによる方法の２種類あります。  
いずれを用いるかは以下を使って設定できます。
- クラスタ定義ファイル(gs_cluster.json)
- ヒント

クラスタ定義ファイル(gs_cluster.json)を使う場合：

  * /sql/costBasedIndexScan：結合処理における索引スキャンの方法の決定にコストベースによる方法を用いるかどうかを指定します。用いない(false)場合は、ルールベースを用いて索引スキャンの方法を決定します。デフォルト値はコストベースによる方法(true)です。

ヒントを使う場合：

  * CostBasedIndexScan()：コストベースによる方法で索引スキャン方法を決定します。
  * NoCostBasedIndexScan()：コストベースによる方法を用いないで、ルールベースによる方法で索引スキャン方法を決定します。

## SQLリソーススケジューリング機能

「処理順序制御」、「メモリ使用量に応じた実行制御」、「リソース監視」の3つの機能から構成されます。

### 処理順序制御

新スケジューラでは、SQLごとに極力均等にタスクを割り当ててスケジューリングします。SQL単位で公平にタスクを分散することで、リソースの偏りや待ち行列の発生を抑制し、全体の応答性能を安定化させることが可能です。

ノード定義ファイル(gs_node.json)の以下のパラメータで設定します。

  * /sql/resourceControlLevel: 後述のfailOnTotalMemoryLimitがtrueの場合のスケジューラの動作レベル。
    - 0: 制御レベルを自動設定（デフォルトでレベル3=新スケジューラが適用されます）
    - 1: 旧スケジューラ(SQLメモリ上限設定なし) (V5.6相当)
    - 2: 旧スケジューラ(SQLメモリ上限設定あり) (V5.7/V5.8相当)
    - 3: 新スケジューラ

### メモリ使用量に応じた実行制御

SQL処理に使用されるメモリの総量をノード単位で制限することで、負荷の高いSQLによるメモリ枯渇やサーバダウンを防止します。  
V5.7で、上限を超えるメモリが必要と判断されたSQLを強制停止する機能が追加されました。
V5.9の新スケジューラでは、上限値に基づいてSQLの実行をより適切に制御し、停止対象のSQLを自動的に判断することで、安定性と制御精度が向上しています。

ノード定義ファイル(gs_node.json)の以下のパラメータで設定します。

  * /sql/failOnTotalMemoryLimit: 上限超過時の動作を制御。true に設定すると、上限を超えたSQLは強制停止されます。
  * /sql/totalMemoryLimit: ノード単位のSQL処理用メモリの総上限。0 を指定した場合は自動計算式が適用されます。

### リソース監視

新スケジューラでは、SQLごとのリソース使用状況（メモリ・I/O・通信時間など）を詳細に監視し、イベントログやメタテーブルに出力することが可能です。これにより、リソースを過剰に消費するSQLや、システム負荷の原因となるクエリを特定しやすくなり、パフォーマンスチューニングや障害対応に役立ちます。

ノード定義ファイル(gs_node.json)の/trace/resourceMonitor を LEVEL_WARNING に設定し、監視対象を以下のパラメータで設定します。

  * /sql/monitoringMemoryRate: メモリ消費総量の監視対象とする比率（上限値基準）。0～1で指定。0の場合は監視を無効化。
  * /sql/monitoringStoreRate: SQL中間ストア使用量の監視対象とする比率（上限値基準）。0～1で指定。0の場合は監視を無効化。
  * /sql/monitoringNetworkRate: SQL通信占有時間の監視イベントログ出力対象とする、監視間隔時間内での総転送時間を基準とした比率。0～1で指定。0の場合は監視を無効化。
  * /transaction/monitoringStoreRate: データストアアクセス量(概算値)の監視イベントログ出力対象とする、データストアメモリ上限値を基準とした比率。0～1で指定。0の場合は監視を無効化。

以下の手段でリソース使用状況を確認することができます。
- イベントログ
- メタテーブル
  * #statement_resources
  * #task_resources

## 行パターン認識機能

MATCH_RECOGNIZE句が新たに追加されました。基本構文は以下の通りです。

``` example
MATCH_RECOGNIZE (
  [PARTITION BY 式1 [, 式2 ...]]
  [ORDER BY 式3 [, 式4 ...]]
  [MEASURES 式5 [AS エイリアス1][, 式6 [AS エイリアス2], ...]]
  [ONE ROW PER MATCH | ALL ROWS PER MATCH]
  [AFTER MATCH SKIP スキップオプション]
  PATTERN (パターン指定)
  DEFINE パターン変数1 AS 条件式1 [, パターン変数2 AS 条件式2, ...]
)

- PARTITION BY：パターン認識のグループ化単位を指定します。
- ORDER BY：パターン認識の並び順を指定します。
- MEASURES：パターン一致時に出力する追加情報を指定します。
- PATTERN：認識したいパターン（正規表現風）を指定します。
- DEFINE：パターン変数ごとの判定条件を指定します。
- ONE ROW PER MATCH / ALL ROWS PER MATCH：出力単位を制御します（省略時はONE ROW）。
- AFTER MATCH SKIP：「PAST LAST ROW」のみサポートしています。

MEASURES、DEFINEでは、MATCH_RECOGNIZE固有の関数（MATCH_NUMBER(), CLASSIFIER(), PREV(), NEXT(), FIRST(), LAST()）を利用できます。

```


例)

``` example
SELECT *
FROM sensor_data
MATCH_RECOGNIZE (
  PARTITION BY device_id
  ORDER BY timestamp
  MEASURES
    FIRST(timestamp) AS start_time,
    LAST(timestamp) AS end_time
  PATTERN (UP+ DOWN+)
  DEFINE
    UP AS value > PREV(value),
    DOWN AS value < PREV(value)
);

device_id   timestamp    value   start_time   end_time     match_no 
-----------+------------+-------+------------+------------+--------- 
devA        2025-09-01   10      2025-09-01   2025-09-05   1 
devA        2025-09-02   12      2025-09-01   2025-09-05   1 
devA        2025-09-03   15      2025-09-01   2025-09-05   1 
devA        2025-09-04   13      2025-09-01   2025-09-05   1 
devA        2025-09-05   11      2025-09-01   2025-09-05   1
```
